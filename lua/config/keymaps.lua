-- ============================================================================
-- 键位映射配置文件
-- ============================================================================
-- 键位映射会在 VeryLazy 事件时自动加载
-- LazyVim 默认键位映射: https://github.com/LazyVim/LazyVim/blob/main/lua/lazyvim/config/keymaps.lua
-- ============================================================================

local Util = require("lazyvim.util")

-- ============================================================================
-- 辅助函数
-- ============================================================================

--- 简化键位映射函数
--- @param mode string|table 模式 (n=普通, i=插入, v=可视, t=终端)
--- @param lhs string 按键组合
--- @param rhs string|function 执行的命令或函数
--- @param opts table|nil 选项 (可选)
function Map(mode, lhs, rhs, opts)
  local options = { noremap = true, silent = true }
  if opts then
    -- 合并选项，冲突时使用右侧参数的值
    options = vim.tbl_extend("force", options, opts)
  end
  vim.keymap.set(mode, lhs, rhs, options)
end

-- ============================================================================
-- 基础编辑键位
-- ============================================================================

-- 快速退出插入模式和可视模式
Map("i", "jk", "<Esc>", { desc = "退出插入模式" })
Map("v", "jk", "<Esc>", { desc = "退出可视模式" })

-- 快速保存文件
Map("n", "<C-s>", ":w<CR>", { desc = "保存文件" })

-- 删除整个文件内容
Map("n", "<leader>dd", ":%delete _<CR>", { desc = "删除所有内容" })

-- ============================================================================
-- 光标移动优化
-- ============================================================================

-- Shift+H/L 快速跳转到行首/行尾 (普通模式)
Map("n", "<S-h>", "^", { desc = "跳转到行首" })
Map("n", "<S-l>", "$", { desc = "跳转到行尾" })

-- Shift+H/L 快速跳转到行首/行尾 (可视模式)
Map("v", "<S-h>", "^", { desc = "跳转到行首" })
Map("v", "<S-l>", "$", { desc = "跳转到行尾" })

-- ============================================================================
-- 窗口管理
-- ============================================================================

-- 分割窗口
Map("n", "ss", "<C-w>s", { desc = "水平分割窗口", remap = true })
Map("n", "so", "<C-w>o", { desc = "关闭其他窗口", remap = true })

-- 使用方向键调整窗口大小
Map("n", "<Up>", ":resize -2<CR>", { desc = "减小窗口高度" })
Map("n", "<Down>", ":resize +2<CR>", { desc = "增加窗口高度" })
Map("n", "<Left>", ":vertical resize -2<CR>", { desc = "减小窗口宽度" })
Map("n", "<Right>", ":vertical resize +2<CR>", { desc = "增加窗口宽度" })

-- ============================================================================
-- LSP 功能
-- ============================================================================

-- Lspsaga 查找引用
Map("n", "gf", "<cmd>Lspsaga finder<CR>", { desc = "查找引用" })

-- Lspsaga 跳转到定义
Map("n", "gd", "<cmd>Lspsaga goto_definition<CR>", { desc = "跳转到定义" })

-- ============================================================================
-- 终端管理
-- ============================================================================

-- 切换浮动终端 (普通模式和终端模式)
Map({ "n", "t" }, "<C-t>", "<cmd>Lspsaga term_toggle<CR>", { desc = "切换浮动终端" })

-- ============================================================================
-- Git 集成
-- ============================================================================

-- 打开 Lazygit
Map("n", "<C-g>", function()
  Util.terminal({ "lazygit" }, { cwd = Util.root(), esc_esc = false, ctrl_hjkl = false })
end, { desc = "打开 Lazygit" })

-- ============================================================================
-- Telescope 模糊查找
-- ============================================================================

-- 查找缓冲区
Map("n", "<C-b>", ":Telescope buffers<CR>", { desc = "查找缓冲区" })

-- 全局文本搜索
Map("n", "<C-f>", ":Telescope live_grep<CR>", { desc = "全局搜索文本" })
